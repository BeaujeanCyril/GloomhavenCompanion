@page "/deck"
@using GloomhavenCompanion.ViewModels
@inject AppState AppState

@code {
	[Parameter]
	public string DeckName { get; set; }

	protected DeckViewModel SelectedDeck { get; set; }
	protected PlayerViewModel CurrentPlayer { get; set; }

	private bool showingBackCard = true;
	private const string BackCardImagePath = "img/DeckModifier/Monsters/gh-am-m-back.png";
	private CardViewModel currentCard;

	protected override void OnParametersSet()
	{
		SelectedDeck = AppState.Decks.FirstOrDefault(deck => deck.Name.Equals(DeckName, StringComparison.OrdinalIgnoreCase));
		CurrentPlayer = AppState.CurrentPlayer;
		CurrentPlayer.Deck.ShuffleDeck();

		currentCard = new CardViewModel { ImagePath = BackCardImagePath };
	}

	private async Task ShowBackCardThenShuffleAsync()
	{
		currentCard = new CardViewModel { ImagePath = BackCardImagePath };
		CurrentPlayer.Deck.ShuffleDeck();
		showingBackCard = !showingBackCard;
		StateHasChanged();
	}

	private async Task ShowNextCardAsync()
	{
		if (showingBackCard)
		{
			currentCard = SelectedDeck.CardsList.FirstOrDefault();
		}
		else
		{
			showingBackCard = true;
			currentCard = new CardViewModel { ImagePath = BackCardImagePath };
			StateHasChanged();
			await Task.Delay(1000);
			currentCard = SelectedDeck.CardsList.FirstOrDefault();
		}
		CurrentPlayer.Deck.ShowAndMoveFirstCardToEnd();
		showingBackCard = false;
		if(currentCard.NeedShuffle == true)
		{
			CurrentPlayer.Deck.ShuffleDeck();
		}
		StateHasChanged();
	}

	private async Task AddAnnulCard()
	{
		CurrentPlayer.Deck.AddAnnulCard();
		CurrentPlayer.Deck.ShuffleDeck();
		StateHasChanged();

	}

	private async Task AddBenedictionCard()
	{
		CurrentPlayer.Deck.AddX2Card();
		CurrentPlayer.Deck.ShuffleDeck();
		StateHasChanged();

	}
}

<MudContainer>
	<MudGrid Class="text-align: center">
		<MudPaper Class="p-2 m-2" Style="height: 200px; text-align: center;">
			<h2>@SelectedDeck.Name</h2>
			@if (SelectedDeck?.CardsList != null && SelectedDeck.CardsList.Any())
			{
				<CardMolecule Card="@(showingBackCard ? new CardViewModel { ImagePath = BackCardImagePath, Value = "" } : currentCard)" />
@* 				<MudButton Color="Color.Primary" @onclick="ShowBackCardThenShuffleAsync">Mélanger</MudButton>
 *@				<MudButton Color="Color.Secondary" @onclick="ShowNextCardAsync">Carte suivante</MudButton>
							<MudButton Color="Color.Secondary" @onclick="AddAnnulCard">Ajout annuler</MudButton>
							<MudButton Color="Color.Secondary" @onclick="AddBenedictionCard">Ajout bénédiction</MudButton>
			}
			else
			{
				<p>Aucune carte disponible dans le deck.</p>
			}
		</MudPaper>
	</MudGrid>
 	<MudGrid>
		@foreach (var card in SelectedDeck.CardsList)
		{
			<MudItem xs="6" sm="4" md="3" lg="2">
				<MudPaper Class="p-2 m-2" Style="height: 150px; text-align: center;">
					<img src="@card.ImagePath" alt="@card.Value" style="max-width: 100%; max-height: 80%; object-fit: contain;" />
					<h3>@card.Value</h3>
					<p>Need Shuffle: @card.NeedShuffle</p>
				</MudPaper>
			</MudItem>
		}
	</MudGrid>
 

</MudContainer>